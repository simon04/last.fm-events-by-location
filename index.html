<!DOCTYPE HTML>
<html ng-app>
  <head>
    <meta charset="utf-8" />
    <script>
      function LastFmCalendar($scope, $http) {

        $scope.location = 'Innsbruck, Austria';
        $scope.distance = 20;

        $scope.getEvents = function() {
          return $http.get('http://ws.audioscrobbler.com/2.0/',
            {
              headers: {
                'Accept': 'application/xml',
              },
              params: {
                method: 'geo.getEvents',
                location: $scope.location,
                distance: $scope.distance,
                limit: 200,
                api_key: '6a784d8c155badb9591723ef67d17478',
                format: 'json',
              },
            }
            ).then(function(lastfm) {
              return lastfm.data.events.event;
            });
          };

        $scope.updateEvents = function() {
          $scope.events = $scope.getEvents();
        };
        $scope.updateEvents();

        $scope.filterList = function(events) {
          _.mixin({
            pluckArray: function(obj, key) {
              return _.map(obj, function(value){
               return _.reduce(key, function(v, k){
                return v[k]; 
              }, value)
             })
            }
          });

          var venues = _.chain(events).pluckArray(['venue', 'name']).value();
          var artists = _.chain(events).pluckArray(['artists', 'artist']).flatten().value();
          var titles = _.chain(events).pluckArray(['title']).flatten().value();
          return _.unique(_.union(venues, artists, titles));
        };

        $scope.humanize = function(date) {
          moment.lang('en', {
            calendar : {
              lastWeek : '[last] dddd [at] LT',
              lastDay : '[Yesterday at] LT',
              sameDay : '[Today]',
              nextDay : '[Tomorrow]',
              nextWeek : 'dddd',
              sameElse : 'LL'
            }
          });
          return moment(date).calendar();
        };

        $scope.asArray = function(x) {
          return Array.isArray(x) ? x : [x];
        };

        $scope.moment = moment;
      }
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.5/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js"></script>
    <script src="https:////cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/css/bootstrap.min.css" />
    <style>
      time {
        white-space: nowrap;
      }
      img.thumb {
        max-width: none !important;
        width: auto !important;
      }
      .crop {
        height: 87px !important;
        overflow: hidden;
      }
      .cancelled td {
        text-decoration: line-through;
        opacity: 0.5;
      }
    </style>
  </head>
  <body ng-controller="LastFmCalendar">
    <div class="navbar">
      <div class="navbar-inner">
        <span class="brand">
          <a href="http://last.fm/">
            <img src="http://cdn.last.fm/flatness/badges/lastfm_red_small.gif">
          </a>
        </span>
        <div class="container">
          <form class="navbar-form form-search" ng-submit="updateEvents()">
            <input ng-model="location" type="text" class="input-xlarge search-query" placeholder="Location" title="Location">
            <input ng-model="distance" type="number" class="input-mini search-query" title="Distance (in kilometers)">
            <button type="submit" class="btn">Update Events</button>
            <input ng-model="filter" type="search" class="input-medium search-query" placeholder="Filter" title="Filter" class="btn" list="filterList">
          </form>
        </div>
      </div>
    </div>
    <datalist id="filterList">
      <option ng-repeat="i in filterList(events)" value="{{i}}"/>
    </datalist>
    <div class="container-fluid">
      <table class="table table-striped">
        <tr>
          <th>Date</th>
          <th>Venue</th>
          <th></th>
          <th>Event and Artists</th>
        </tr>
        <tr ng-repeat="e in events | filter:filter" ng-class="{cancelled:e.cancelled==1}">
          <td>
            <time datetime="{{moment(e.startDate).format()}}">
              {{humanize(e.startDate)}}
            </time>
          </td>
          <td>
            <a ng-show="e.website" ng-href="{{e.website}}">{{e.venue.name}}</a>
            <span ng-show="!e.website">{{e.venue.name}}</span>
          </td>
          <td>
            <div class="crop">
              <img class="thumb" ng-src="{{e.image[2]['#text']}}">
            </div>
          </td>
          <td>
            <p>
              <a href="{{e.url}}">
                <b>
                  {{e.title}}
                </b>
              </a>
            </p>
            <ul ng-hide="e.title == e.artists.artist" ng-repeat="artist in asArray(e.artists.artist)">
              <li>{{artist}}</li>
            </ul>
          </td>
        </tr>
      </table>
    </div>
  </body>
</html>

